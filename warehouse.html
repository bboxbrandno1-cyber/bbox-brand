<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BBOX | CLOUD CONTROL</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
        <h2 class="text-3xl font-black mb-8 text-center uppercase tracking-tighter">BBOX WAREHOUSE</h2>
        <div class="space-y-4">
            <input type="file" id="imageInput" class="w-full border-2 border-dashed rounded-lg p-4 bg-gray-50 cursor-pointer">
            <input type="text" id="name" placeholder="Product Name" class="w-full border p-4 rounded-lg outline-none">
            <input type="number" id="price" placeholder="Price (Rs.)" class="w-full border p-4 rounded-lg outline-none">
            <select id="category" class="w-full border p-4 rounded-lg bg-white">
                <option>T-SHIRTS</option>
                <option>TRACK SUITS</option>
                <option>HOODIES</option>
            </select>
            <button onclick="publishToStore()" id="btn" class="w-full bg-black text-white py-5 rounded-lg font-bold uppercase tracking-widest hover:bg-zinc-800 transition-all">
                Publish From Gallery
            </button>
        </div>
        <div id="status" class="mt-4 text-center text-xs text-gray-400">System: Secure GitHub Mode</div>
    </div>

    <script>
        const IMGBB_KEY = "6e7d18cc7275f1ed12b62b19d6e95233"; 
        const REPO = "bboxbrandno1-cyber/bbox-brand";

        async function publishToStore() {
            // Har baar upload par ye aapse token mangega
            const GH_TOKEN = prompt("Meharbani karke apna GitHub Token yahan paste karein:");
            if(!GH_TOKEN) return alert("Token ke bagair upload nahi ho sakta!");

            const btn = document.getElementById('btn');
            const file = document.getElementById('imageInput').files[0];
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const category = document.getElementById('category').value;

            if(!file || !name || !price) return alert("Pura data bharein!");

            btn.innerText = "UPLOADING...";
            btn.disabled = true;

            try {
                // 1. Upload to ImgBB
                const fd = new FormData();
                fd.append("image", file);
                const imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const imgData = await imgRes.json();
                const imageUrl = imgData.data.url;

                // 2. Fetch products.json from GitHub
                const ghUrl = `https://api.github.com/repos/${REPO}/contents/products.json`;
                const resFetch = await fetch(ghUrl, { headers: { Authorization: `token ${GH_TOKEN}` } });
                
                if(resFetch.status === 401) throw new Error("Ghalat Token!");
                
                const fileData = await resFetch.json();
                const products = JSON.parse(atob(fileData.content));

                // 3. Add New Product
                const newProduct = { id: Date.now(), name, price, category, imageUrl, date: new Date().toLocaleDateString() };
                products.unshift(newProduct);

                // 4. Save Back to GitHub
                const resPut = await fetch(ghUrl, {
                    method: "PUT",
                    headers: { Authorization: `token ${GH_TOKEN}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: `Added: ${name}`,
                        content: btoa(JSON.stringify(products, null, 2)),
                        sha: fileData.sha
                    })
                });

                if(resPut.ok) {
                    alert("Zabardast! Product website par live ho gaya hai.");
                    location.reload();
                } else {
                    alert("Kuch masla hai, shayad token block ho gaya.");
                }

            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Publish From Gallery";
            }
        }
    </script>
</body>
</html>
